<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Car Deals - All Cars</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #fff; margin: 0; padding: 0; }
    .container { max-width: 1100px; margin: 40px auto; background: #181818; border-radius: 10px; box-shadow: 0 2px 16px #0008; padding: 28px; }
    h1 { text-align: center; margin-bottom: 18px; }
    .sort-bar { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 18px; }
    .sort-label { margin-right: 8px; font-size: 1em; color: #ccc; }
    .sort-select { background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; padding: 4px 10px; font-size: 1em; }
    .car-list { display: flex; flex-wrap: wrap; gap: 24px; justify-content: center; }
    .car-card {
      background: #222;
      border: 1px solid #333;
      border-radius: 8px;
      width: 270px;
      padding: 16px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: box-shadow 0.2s, border 0.2s, background 0.2s;
      color: #fff;
    }
    .car-card.removed {
      border: 2px solid #e53935;
      background: #2a1818;
      opacity: 0.7;
    }
    .car-card.removed .car-title,
    .car-card.removed .car-info,
    .car-card.removed .car-status {
      color: #ffbdbd;
    }
    .car-img { width: 240px; height: 160px; object-fit: cover; border-radius: 6px; margin-bottom: 12px; background: #333; }
    .car-title {
      font-size: 1.1em;
      font-weight: bold;
      margin-bottom: 6px;
      text-align: center;
      color: #fff;
      word-break: break-word;
      white-space: pre-line;
      overflow-wrap: anywhere;
    }
    .car-info { font-size: 0.97em; color: #eee; margin-bottom: 8px; text-align: center; }
    .car-link { color: #4fc3f7; text-decoration: none; font-size: 0.97em; }
    .car-link:hover { text-decoration: underline; }
    .car-status { font-size: 0.9em; color: #aaa; margin-top: 4px; }
    .car-year { color: #ff9800; }
    .car-price { color: #4fc3f7; font-weight: bold; font-size: 1.05em; }
    .car-km-excellent { color: #4caf50; font-weight: bold; } /* 0-50k - Green */
    .car-km-good { color: #8bc34a; font-weight: bold; } /* 50k-100k - Light Green */
    .car-km-fair { color: #ff9800; font-weight: bold; } /* 100k-150k - Orange */
    .car-km-high { color: #ff5722; font-weight: bold; } /* 150k-200k - Red Orange */
    .car-km-very-high { color: #f44336; font-weight: bold; } /* 200k+ - Red */
  </style>
</head>
<body>
  <div class="container">
    <h1>All Cars in Database</h1>
    <div class="sort-bar">
      <label class="sort-label" for="year-filter">Year:</label>
      <select class="sort-select" id="year-filter">
        <option value="all">All</option>
        <option value="2019">2019</option>
        <option value="2020">2020</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
        <option value="2024">2024</option>
        <option value="2025">2025</option>
      </select>
      <label class="sort-label" for="min-price-filter" style="margin-left: 20px;">Min Price:</label>
      <select class="sort-select" id="min-price-filter">
        <option value="all">All</option>
        <option value="30000">30,000</option>
        <option value="35000">35,000</option>
        <option value="40000">40,000</option>
        <option value="45000">45,000</option>
        <option value="50000">50,000</option>
        <option value="55000">55,000</option>
        <option value="60000">60,000</option>
      </select>
      <label class="sort-label" for="max-km-filter" style="margin-left: 20px;">Max KM:</label>
      <select class="sort-select" id="max-km-filter">
        <option value="all">All</option>
        <option value="50000">50,000</option>
        <option value="100000">100,000</option>
        <option value="150000">150,000</option>
        <option value="200000">200,000</option>
      </select>
      <label class="sort-label" for="sort-by" style="margin-left: 20px;">Sort by:</label>
      <select class="sort-select" id="sort-by">
        <option value="price">Price</option>
        <option value="year">Year</option>
        <option value="kilometers">Kilometers</option>
        <option value="created_date">Created</option>
      </select>
      <button class="sort-select" id="sort-direction" style="margin-left: 10px;">Asc</button>
      <button class="sort-select" id="toggle-saved" style="margin-left: 20px;">Show Saved Only</button>
    </div>
    <div class="car-list" id="car-list"></div>
  </div>
  <script>
  let allCars = [];
  let currentSort = 'price';
  let currentYearFilter = 'all';
  let currentMaxKmFilter = 'all';
  let currentMinPriceFilter = 'all';
  let currentSortDirection = 'asc';
  const list = document.getElementById('car-list');
  const sortSelect = document.getElementById('sort-by');
  const yearFilterSelect = document.getElementById('year-filter');
  const minPriceFilterSelect = document.getElementById('min-price-filter');
  const maxKmFilterSelect = document.getElementById('max-km-filter');
  const sortDirectionBtn = document.getElementById('sort-direction');

    // Function to get URL parameters
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        sort: params.get('sort') || 'price',
        year: params.get('year') || 'all',
        min_price: params.get('min_price') || 'all',
        max_km: params.get('max_km') || 'all',
        direction: params.get('direction') || 'asc'
      };
    }

    // Function to update URL with current parameters
    function updateUrl() {
      const params = new URLSearchParams();
      if (currentSort !== 'price') {
        params.set('sort', currentSort);
      }
      if (currentYearFilter !== 'all') {
        params.set('year', currentYearFilter);
      }
      if (currentMinPriceFilter !== 'all') {
        params.set('min_price', currentMinPriceFilter);
      }
      if (currentMaxKmFilter !== 'all') {
        params.set('max_km', currentMaxKmFilter);
      }
      if (currentSortDirection !== 'asc') {
        params.set('direction', currentSortDirection);
      }
      const newUrl = params.toString() ? 
        `${window.location.pathname}?${params.toString()}` : 
        window.location.pathname;
      window.history.replaceState({}, '', newUrl);
    }

    // Initialize from URL parameters
    function initializeFromUrl() {
  const urlParams = getUrlParams();
  currentSort = urlParams.sort;
  currentYearFilter = urlParams.year;
  currentMinPriceFilter = urlParams.min_price;
  currentMaxKmFilter = urlParams.max_km;
  currentSortDirection = urlParams.direction;
  // Set dropdown values
  sortSelect.value = currentSort;
  yearFilterSelect.value = currentYearFilter;
  minPriceFilterSelect.value = currentMinPriceFilter;
  maxKmFilterSelect.value = currentMaxKmFilter;
  sortDirectionBtn.textContent = currentSortDirection === 'asc' ? 'Asc' : 'Desc';
    }

    function filterCarsByYear(cars, yearFilter) {
      if (yearFilter === 'all') {
        return cars;
      }
      const filterYear = parseInt(yearFilter);
      return cars.filter(car => {
        const carYear = parseInt(car.year);
        return !isNaN(carYear) && carYear === filterYear;
      });
    }

    function filterCarsByMinPrice(cars, minPriceFilter) {
      if (minPriceFilter === 'all') {
        return cars;
      }
      const minPrice = parseInt(minPriceFilter);
      return cars.filter(car => {
        if (!car.price) return false;
        const price = parseInt(car.price.toString().replace(/\D/g, ''));
        return !isNaN(price) && price >= minPrice;
      });
    }

    function filterCarsByMaxKm(cars, maxKmFilter) {
      if (maxKmFilter === 'all') {
        return cars;
      }
      const maxKm = parseInt(maxKmFilter);
      return cars.filter(car => {
        if (!car.kilometers) return false;
        const km = parseInt(car.kilometers.toString().replace(/\D/g, ''));
        return !isNaN(km) && km <= maxKm;
      });
    }

    function getKilometerColorClass(kilometers) {
      if (!kilometers) return '';
      
      const km = parseInt(kilometers.toString().replace(/\D/g, ''));
      if (isNaN(km)) return '';
      
      if (km <= 100000) return 'car-km-excellent';
      if (km <= 160000) return 'car-km-good';
      if (km <= 220000) return 'car-km-fair';
      if (km <= 250000) return 'car-km-high';
      return 'car-km-very-high';
    }

    function formatKilometers(kilometers) {
      if (!kilometers) return '';
      
      // Extract numeric value from the string
      const numericValue = kilometers.toString().replace(/\D/g, '');
      if (!numericValue) return kilometers;
      
      const km = parseInt(numericValue);
      if (isNaN(km)) return kilometers;
      
      // Add comma separators for thousands
      return km.toLocaleString();
    }

    function getCarId(car) {
      // Use a unique identifier for each car (listing_url or brand+model+year+price)
      return car.listing_url || `${car.brand || ''}_${car.model || ''}_${car.year || ''}_${car.price || ''}`;
    }

    function getSavedCarIds() {
      try {
        return JSON.parse(localStorage.getItem('savedCars') || '[]');
      } catch (e) {
        return [];
      }
    }

    function setSavedCarIds(ids) {
      localStorage.setItem('savedCars', JSON.stringify(ids));
    }

    function isCarSaved(car) {
      const id = getCarId(car);
      const saved = getSavedCarIds();
      return saved.includes(id);
    }

    function toggleSaveCar(car) {
      const id = getCarId(car);
      let saved = getSavedCarIds();
      if (saved.includes(id)) {
        saved = saved.filter(x => x !== id);
      } else {
        saved.push(id);
      }
      setSavedCarIds(saved);
    }

    function cleanSavedCars(cars) {
      // Remove saved cars not present in loaded cars
      const validIds = new Set(cars.map(getCarId));
      let saved = getSavedCarIds();
      const cleaned = saved.filter(id => validIds.has(id));
      if (cleaned.length !== saved.length) {
        setSavedCarIds(cleaned);
      }
    }

    function renderCars(cars) {
      list.innerHTML = '';
      if (!cars.length) {
        list.innerHTML = '<p>No cars found in the database.</p>';
        return;
      }
      cars.forEach(car => {
        const card = document.createElement('div');
        card.className = 'car-card' + (car.status === 'removed' ? ' removed' : '');
        const img = document.createElement('img');
        img.className = 'car-img';
        img.src = (car.image_urls && car.image_urls.length) ? car.image_urls[0] : '';
        img.alt = (car.brand || '') + ' ' + (car.model || '');
        card.appendChild(img);
        const title = document.createElement('div');
        title.className = 'car-title';
        // Create title with orange year
        const brand = car.brand || '';
        const model = car.model || '';
        const year = car.year || '';
        let titleHtml = `${brand} ${model}`.trim();
        if (year) {
          titleHtml += ` <span class="car-year">${year}</span>`;
        }
        if (titleHtml.length > 30) {
          title.innerHTML = titleHtml;
        } else {
          title.innerHTML = titleHtml;
        }
        card.appendChild(title);
        const info = document.createElement('div');
        info.className = 'car-info';
        const kmColorClass = getKilometerColorClass(car.kilometers);
        const formattedKm = formatKilometers(car.kilometers);
        info.innerHTML =
          (car.price ? `<b>Price:</b> <span class="car-price">${car.price} ${car.currency || ''}</span><br>` : '') +
          (car.kilometers ? `<b>KM:</b> <span class="${kmColorClass}">${formattedKm}</span><br>` : '') +
          (car.location ? `<b>Location:</b> ${car.location}<br>` : '') +
          (car.created_date ? `<b>Created:</b> ${car.created_date.split(' ')[0]}<br>` : '') +
          (car.removed_date ? `<b>Removed:</b> ${car.removed_date}<br>` : '');
        card.appendChild(info);
        if (car.listing_url) {
          const link = document.createElement('a');
          link.className = 'car-link';
          link.href = car.listing_url;
          link.target = '_blank';
          link.textContent = 'View Listing';
          card.appendChild(link);
        }
        if (car.status) {
          const status = document.createElement('div');
          status.className = 'car-status';
          status.textContent = `Status: ${car.status}`;
          card.appendChild(status);
        }
        // Add Save/Unsave button
        const saveBtn = document.createElement('button');
        saveBtn.className = 'sort-select';
        saveBtn.style.marginTop = '10px';
        saveBtn.textContent = isCarSaved(car) ? 'Unsave' : 'Save';
        saveBtn.onclick = function() {
          toggleSaveCar(car);
          updateCarDisplay();
        };
        card.appendChild(saveBtn);
        list.appendChild(card);
      });
    }

    function sortCars(cars, by) {
      let sorted;
      if (by === 'created_date') {
        sorted = cars.slice().sort((a, b) => {
          let va = a.created_date || '';
          let vb = b.created_date || '';
          let da = va ? new Date(va.replace(' ', 'T')) : new Date(0);
          let db = vb ? new Date(vb.replace(' ', 'T')) : new Date(0);
          return da - db;
        });
      } else {
        sorted = cars.slice().sort((a, b) => {
          let va = a[by] ?? Infinity;
          let vb = b[by] ?? Infinity;
          if (typeof va === 'string') va = parseInt(va.replace(/\D/g, '')) || Infinity;
          if (typeof vb === 'string') vb = parseInt(vb.replace(/\D/g, '')) || Infinity;
          return va - vb;
        });
      }
      if (currentSortDirection === 'desc') {
        sorted.reverse();
      }
      return sorted;
    }

    let showSavedOnly = false;
    function updateCarDisplay() {
      let cars = allCars;
      if (showSavedOnly) {
        const savedIds = new Set(getSavedCarIds());
        cars = cars.filter(car => savedIds.has(getCarId(car)));
      }
  let filteredCars = filterCarsByYear(cars, currentYearFilter);
  filteredCars = filterCarsByMinPrice(filteredCars, currentMinPriceFilter);
  filteredCars = filterCarsByMaxKm(filteredCars, currentMaxKmFilter);
  const sortedCars = sortCars(filteredCars, currentSort);
  renderCars(sortedCars);
  updateUrl();
    }

    // Initialize from URL parameters
    initializeFromUrl();

    fetch('cars.json')
      .then(r => r.json())
      .then(data => {
        allCars = data.cars || [];
        cleanSavedCars(allCars);
        updateCarDisplay();
      });

    sortSelect.addEventListener('change', function() {
  currentSort = sortSelect.value;
  updateCarDisplay();
    });

    yearFilterSelect.addEventListener('change', function() {
      currentYearFilter = yearFilterSelect.value;
      updateCarDisplay();

    });

    minPriceFilterSelect.addEventListener('change', function() {
      currentMinPriceFilter = minPriceFilterSelect.value;
      updateCarDisplay();

    });

    maxKmFilterSelect.addEventListener('change', function() {
      currentMaxKmFilter = maxKmFilterSelect.value;
      updateCarDisplay();
        });

        sortDirectionBtn.addEventListener('click', function() {
          currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
          sortDirectionBtn.textContent = currentSortDirection === 'asc' ? 'Asc' : 'Desc';
          updateCarDisplay();
    });

    // Toggle saved only view
    const toggleSavedBtn = document.getElementById('toggle-saved');
    toggleSavedBtn.addEventListener('click', function() {
      showSavedOnly = !showSavedOnly;
      toggleSavedBtn.textContent = showSavedOnly ? 'Show All' : 'Show Saved Only';
      updateCarDisplay();
    });

    // Handle browser back/forward buttons
    window.addEventListener('popstate', function() {
      initializeFromUrl();
      updateCarDisplay();
    });
  </script>
</body>
</html>
